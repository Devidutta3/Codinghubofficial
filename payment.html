<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodingHub | Secure Payment</title>
    <meta name="description" content="Complete your CodingHub enrollment with a secure payment scan or form submission.">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="icon" href="assets/codinghub-logo.svg" type="image/svg+xml">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="bg-glow top-left"></div>
    <div class="bg-glow bottom-right"></div>

    <nav>
        <div class="logo">
            <a href="index.html" class="logo-brand">
                <img src="assets/codinghub-logo.svg" alt="CodingHub logo" class="logo-mark">
                <span class="logo-text"><span class="text-gradient">Coding</span><span>Hub</span></span>
            </a>
        </div>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="courses.html">Courses</a></li>
            <li><a href="team.html">Community</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="payment.html" class="text-gradient">Payment</a></li>
            <li><a href="login.html" class="btn btn-secondary" style="padding: 0.5rem 1.5rem; border-radius: 20px;">Login</a></li>
        </ul>
    </nav>

    <main>
        <!-- Course Summary Box -->
        <section class="payment-hero" style="padding-bottom: 0; padding-top: 2rem;">
            <div class="glass-card payment-card" id="course-summary-card" style="display:none; text-align: center; border: 1px solid var(--neon-blue);">
                <p class="info-badge">You are enrolling in</p>
                <h2 id="summary-title" style="margin: 1rem 0; font-size: 2rem;">Loading...</h2>
                <p id="summary-desc" style="color: var(--text-secondary); margin-bottom: 1rem;"></p>
                <div style="display: flex; justify-content: center; gap: 1rem; align-items: center;">
                    <span id="summary-price" class="text-gradient" style="font-weight: 800; font-size: 1.5rem;"></span>
                </div>
            </div>
        </section>

        <section class="payment-hero" style="padding-bottom: 0;">
            <div class="glass-card payment-card">
                <p class="info-badge">Step 1 · Identification</p>
                <h1>Generate Student ID</h1>
                <p>Enter your email to generate your unique Student ID. You will need this for payment confirmation.</p>
                <div class="form-wrap" style="max-width: 500px; margin: 2rem auto;">
                    <div class="form-group">
                        <label for="emailInput">Email Address</label>
                        <input type="email" id="emailInput" class="form-control" placeholder="name@example.com">
                    </div>
                    <button onclick="generateStudentId()" class="btn btn-primary" style="width: 100%;">Generate ID & Download Ticket</button>
                    
                    <div id="idResult" style="display: none; margin-top: 2rem; padding: 1rem; background: rgba(0, 240, 255, 0.1); border-radius: 8px; border: 1px solid var(--neon-blue);">
                        <p style="margin-bottom: 0.5rem;">Your Student ID:</p>
                        <h3 id="generatedIdDisplay" class="text-gradient" style="font-size: 2rem; margin-bottom: 0.5rem;"></h3>
                        <p style="font-size: 0.9rem; color: var(--text-secondary);">A file named "Student.txt" has been downloaded. Keep it safe!</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="payment-hero">
            <div class="glass-card payment-card">
                <p class="info-badge">Step 2 · Scan &amp; Confirm</p>
                <h1>Secure your spot at CodingHub</h1>
                <p>Scan the QR code below or open the Google Form to submit your payment confirmation. Watch for
                    the pop-up that confirms receipt before heading back to our site.</p>
                <div class="payment-grid">
                    <div class="qr-wrap">
                        <img src="assets/qrcode.png" alt="CodingHub payment QR code" class="payment-qr">
                        <p class="text-secondary" style="margin-top: 1rem;">Use your banking app or UPI wallet to scan the
                            code. No app? Open the form instead.</p>
                    </div>
                    <div class="form-wrap">
                        <p class="info-badge" style="background: rgba(0, 240, 255, 0.1); color: var(--neon-blue);">
                            Step 3 · Confirm via Form
                        </p>
                        <h3 style="margin-bottom: 0.5rem;">Google Form Link</h3>
                         <p class="info-badge" style="background: rgba(0, 240, 255, 0.1); color: var(--neon-blue);">
                            <a href="https://forms.gle/2gQTomXqDrH7yXbF6">Click Me</a> </p>
                        
                        <p>Add your payment transaction ID and preferred batch timing so we can enroll you quickly.</p>
                        <a href="#" class="btn btn-secondary" target="_blank" rel="noreferrer">Open Payment Form</a>
                        <p class="text-secondary" style="margin-top: 1rem;">
                            Replace the button href with your actual Google Form URL once ready.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <section class="payment-guidelines glass-card">
            <h2 class="section-title">What Happens Next?</h2>
            <div class="grid-3-col" style="gap: 2rem;">
                <div class="step-card">
                    <p class="step-number">01</p>
                    <h4>We validate your payment</h4>
                    <p>Our team cross-checks the transaction ID you submit and verifies the amount.</p>
                </div>
                <div class="step-card">
                    <p class="step-number">02</p>
                    <h4>Access details arrive</h4>
                    <p>Within 12 hours, you'll receive a confirmation e-mail with course links and onboarding info.</p>
                </div>
                <div class="step-card">
                    <p class="step-number">03</p>
                    <h4>Start learning</h4>
                    <p>Enter the Transaction ID you submitted in the form to verify your payment.</p>
                    <input type="text" id="transactionIdInput" class="form-control" placeholder="Enter Transaction ID" style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                    <a href="courses.html" id="start-learning-btn" class="btn btn-secondary" style="margin-top: 0.5rem; display: inline-block;">Verify & Start</a>
                </div>
            </div>
        </section>
    </main>

    <footer id="contact">
        <div class="footer-content">
            <div class="footer-col">
                <div class="logo">
                    <a href="index.html" class="logo-brand">
                        <img src="assets/codinghub-logo.svg" alt="CodingHub logo" class="logo-mark">
                        <span class="logo-text"><span class="text-gradient">Coding</span><span>Hub</span></span>
                    </a>
                </div>
                <p style="margin-top: 1rem;">Empowering the next generation of developers worldwide.</p>
            </div>
            <div class="footer-col">
                <h5>Learning Paths</h5>
                <a href="courses.html">Java Ecosystem</a>
                <a href="pythonlearning.html">Python Mastery</a>
                <a href="frontendlearning.html">Frontend Design</a>
                <a href="aiandbackendlearning.html">Backend &amp; AI</a>
            </div>
            <div class="footer-col">
                <h5>Organization</h5>
                <a href="team.html">Our Team</a>
                <a href="about.html">About Us</a>
                <a href="#">Terms of Service</a>
                <a href="#">Privacy Policy</a>
            </div>
            <div class="footer-col">
                <h5>Connect</h5>
                <a href="mailto:contact@codinghub.com">contact@codinghub.com</a>
                <a href="#">GitHub</a>
                <a href="#">LinkedIn</a>
                <a href="#">Twitter</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 CodingHub. Inspired by freeCodeCamp. Designed by Devidutta Das &amp; Team.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            const course = params.get('course');
            const btn = document.getElementById('start-learning-btn');

            // Static Course Data
            const coursesDB = {
                'java': { title: "Java Ecosystem", description: "Master Java, Spring Boot, and enterprise application development.", price: 0 },
                'python': { title: "Python Mastery", description: "Learn Python for Data Science, AI, and scripting.", price: 0 },
                'c-programming': { title: "C Programming", description: "Understand the fundamentals of computer science and memory management.", price: 0 },
                'frontend': { title: "Frontend Design", description: "Build beautiful interfaces with HTML, CSS, and JavaScript.", price: 0 },
                'ai': { title: "AI & Backend Architecture", description: "Build robust APIs and integrate intelligent models.", price: 0 }
            };
            
            // Load course details from static data
            if (course) {
                const data = coursesDB[course];
                if (data) {
                    const paymentHeaders = document.querySelectorAll('.payment-hero h1');
                    // Target the second header: "Secure your spot..."
                    if (paymentHeaders[1]) {
                        paymentHeaders[1].innerHTML = `Secure your spot for <span class="text-gradient">${data.title}</span>`;
                    }

                    // Update Summary Box
                    const summaryCard = document.getElementById('course-summary-card');
                    if (summaryCard) {
                        summaryCard.style.display = 'block';
                        document.getElementById('summary-title').textContent = data.title;
                        document.getElementById('summary-desc').textContent = data.description;
                        document.getElementById('summary-price').textContent = data.price === 0 ? 'Free' : '$' + data.price;
                    }
                }
            }
            
            let targetUrl = 'trycoursefree.html'; 
            
            if (course === 'java') {
                targetUrl = 'Javamastery.html';
            } else if (course === 'python') {
                targetUrl = 'pythonlearning.html';
            } else if (course === 'frontend') {
                targetUrl = 'frontendlearning.html';
            } else if (course === 'c-programming') {
                targetUrl = 'c-programming.html';
            } else if (course === 'ai') {
                targetUrl = 'aiandbackendlearning.html';
            }
            
            // If user is already enrolled in the requested course, redirect immediately
            if (course && localStorage.getItem('enrolled_' + course) === 'true') {
                window.location.href = targetUrl;
                return;
            }
            
            if (btn) {
                btn.href = "#";
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const txnId = document.getElementById('transactionIdInput').value;
                    
                    // 1. Validate Format: Must be 8-30 alphanumeric characters (Letters & Numbers only)
                    const txnRegex = /^[a-zA-Z0-9]{8,30}$/;
                    if (!txnId || !txnRegex.test(txnId.trim())) {
                        alert("Invalid Transaction ID format. It should be 8-30 alphanumeric characters.");
                        return;
                    }

                    // 2. Verify Payment (Real Check)
                    const originalText = btn.innerText;
                    btn.innerText = "Verifying Payment...";
                    btn.style.opacity = "0.7";
                    btn.style.pointerEvents = "none"; // Prevent double-clicking

                    // REPLACE THIS URL with your deployed Google Apps Script Web App URL
                    const scriptUrl = "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE"; 

                    // If URL is not set, we fallback to simulation for testing
                    if (scriptUrl === "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE") {
                        setTimeout(() => {
                            handleSuccess();
                        }, 2000);
                        return;
                    }

                    fetch(`${scriptUrl}?txnId=${txnId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'valid') {
                                handleSuccess();
                            } else {
                                alert("Transaction ID not found in our records. Please check and try again.");
                                resetBtn();
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert("Error verifying payment. Please try again later.");
                            resetBtn();
                        });

                    function resetBtn() {
                        btn.innerText = originalText;
                        btn.style.opacity = "1";
                        btn.style.pointerEvents = "auto";
                    }

                    function handleSuccess() {
                        resetBtn();
                        const studentId = prompt("Payment Verified! Please enter your Student ID to access the course:");
                        if (studentId && studentId.trim().toUpperCase().startsWith("COH-")) {
                            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                            
                            // If logged in, save to database
                            if (currentUser && currentUser.id && course) {
                                // Mock database save by using localStorage
                                localStorage.setItem('enrolled_' + course, 'true');
                                window.location.href = targetUrl;
                            } else {
                                // Guest fallback
                                if (course) {
                                    localStorage.setItem('enrolled_' + course, 'true');
                                }
                                window.location.href = targetUrl;
                            }
                        } else {
                            alert("Invalid Student ID. It must start with 'COH-'.");
                        }
                    }
                });
            }

            const isEnrolled = Object.keys(localStorage).some(key => key.startsWith('enrolled_') && localStorage.getItem(key) === 'true');
            if (isEnrolled) {
                const navUl = document.querySelector('nav ul');
                if (navUl) {
                    const li = document.createElement('li');
                    li.innerHTML = '<a href="courses.html" class="text-gradient" style="font-weight: 700;">My Learning</a>';
                    navUl.appendChild(li);
                }
            }

            // Check for logged in user
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                const navUl = document.querySelector('nav ul');
                if (navUl) {
                    const loginLink = navUl.querySelector('a[href="login.html"]');
                    if (loginLink && loginLink.parentElement) loginLink.parentElement.remove();

                    const profileLi = document.createElement('li');
                    profileLi.innerHTML = '<a href="profile.html" class="text-gradient" style="font-weight: 700;">My Profile</a>';
                    navUl.appendChild(profileLi);

                    const logoutLi = document.createElement('li');
                    logoutLi.innerHTML = '<a href="#" class="btn btn-secondary" style="padding: 0.5rem 1.5rem; border-radius: 20px;">Logout</a>';
                    logoutLi.querySelector('a').addEventListener('click', (e) => {
                        e.preventDefault();
                        localStorage.removeItem('currentUser');
                        window.location.href = 'index.html';
                    });
                    navUl.appendChild(logoutLi);
                }
            }
        });

        function generateStudentId() {
            const email = document.getElementById('emailInput').value;
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address.');
                return;
            }

            // Check if ID already generated for this email to prevent spam
            const existingId = localStorage.getItem('student_id_' + email);
            if (existingId) {
                document.getElementById('generatedIdDisplay').innerText = existingId;
                document.getElementById('idResult').style.display = 'block';
                alert('An ID has already been generated for this email. Please use the existing ID.');
                return;
            }
            
            // Generate unique ID: COH + Timestamp (base36) + Random (base36)
            const uniquePart = Date.now().toString(36).toUpperCase();
            const randomPart = Math.floor(Math.random() * 1000).toString(36).toUpperCase();
            const studentId = `COH-${uniquePart}-${randomPart}`;
            
            // Store the ID for this email
            localStorage.setItem('student_id_' + email, studentId);
            
            document.getElementById('generatedIdDisplay').innerText = studentId;
            document.getElementById('idResult').style.display = 'block';
            
            // Store in a file name Student (Download)
            const content = `Student Email: ${email}\nStudent ID: ${studentId}\nDate: ${new Date().toLocaleString()}`;
            const blob = new Blob([content], { type: 'text/plain' });
            const anchor = document.createElement('a');
            anchor.download = 'Student.txt';
            anchor.href = window.URL.createObjectURL(blob);
            anchor.click();
        }
    </script>
</body>

</html>
